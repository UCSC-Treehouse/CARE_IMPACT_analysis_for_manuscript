
Documents the use of MSigDB / DGIdb scripts for the CKCC2 project to generate pathway and drug results
for different outlier lists.

## overview

### September 28 2023:
- ETK [generated pathway results and drug results](https://github.com/UCSC-Treehouse/operations/issues/517#issuecomment-1738063538)
 for [outliers gathered by Geoff](https://github.com/UCSC-Treehouse/operations/issues/517#issuecomment-1730522371) in the file "TH34\_rollup\_cohort\_outliers.txt".

File: TH34\_tall\_rollup\_cohort\_outliers\_with\_drugs\_pathways\_2023-09-28.tsv.txt


### October 3:
- ETK [generated pathway and drug results](https://github.com/UCSC-Treehouse/operations/issues/517#issuecomment-1745551134)
for the original tertiary outliers as gathered by Holly.

File: TH34\_tall\_pancancer\_pandisease\_outliers\_with\_drugs\_pathways\_2023-10-03.tsv.txt

### October 20:
- ETK [generated pathway and drug results for non-stringent pan-pandisease outliers](https://github.com/UCSC-Treehouse/operations/issues/517#issuecomment-1775760201)

File: `TH34_tall_lowstringent-pd_drugs_pathways_2023-10-20.tsv.txt`

## details
Follow this process to recompute the generated files with the current (Oct 23) version of the script.
The process described may not exactly match the process used to generate the original version of the file,
but the files created by it are md5 identical to the originals.

### Curated (rollup) outliers
File generated: TH34\_tall\_rollup\_cohort\_outliers\_with\_drugs\_pathways\_2023-09-28.tsv.txt

Start with: [`TH34_rollup_cohort_outliers.txt`](https://github.com/UCSC-Treehouse/operations/issues/517#issuecomment-1563589542)
`MD5 (TH34_rollup_cohort_outliers.txt) = 49d57dadd42ca4a8c157c80ecc815bea`

Run `standalone_dgidb.py`:
```
scriptdir=~/code/analysis-methods/script/DGIdb_and_MSigDB_pathways_aka_GSEA/
$scriptdir/standalone_dgidb.py \
    data/TH34_rollup_cohort_outliers.txt \
    data/TH34_rollup_cohort_outliers_with_drugs_2023-09-20.txt
```

This generates `TH34_rollup_cohort_outliers_with_drugs_2023-09-20.txt`.
`8099d377ce303fb40dec3afbe4c4fd3e  TH34_rollup_cohort_outliers_with_drugs_2023-09-20.txt`

To make an input file for MSigDB, run `table_to_genelist.sh`:

```
source/table_to_genelist.sh \
    data/TH34_rollup_cohort_outliers.txt \
    data/TH34_rollup_cohort_geneLists.txt
```
Generates:
`b91ba0eff356149571ecc039f0218b13  data/TH34_rollup_cohort_geneLists.txt`

Continue setting up MSigDB:
```
mkdir data/pathway_results_rollup_cohort
cd data/pathway_results_rollup_cohort
ln -s ../TH34_rollup_cohort_geneLists.txt geneLists.txt
```

Start docker, mapping the appropriate volumes so you have your workdir, analysis-methods, and the Treehouse archive.
Then, run `standalone_msigdb_pathways.R` to generate pathway result files:

```
screen -S docker

docker run --rm -it -u `id -u`:`id -g` \
-v /private/home/ekephart/code/CKCC2_July_2023/standalone_msigdb:/workdir \
-v /private/home/ekephart/code/analysis-methods/:/analysis-methods:ro \
-v /private/groups/treehouse/archive:/archive:ro \
jupyter/datascience-notebook:python-3.11 /bin/bash

cd /workdir/data/pathway_results_rollup_cohort/
/analysis-methods/script/DGIdb_and_MSigDB_pathways_aka_GSEA/standalone_msigdb_pathways.R
```
This generates 204 pathway result files in `data/pathway_results_rollup_cohort` eg
`TH34_1379_S01-v8-v11_TH03_TH34_rollup_pathway_results.txt`

Finally, we will merge those pathway result files with `TH34_rollup_cohort_outliers_with_drugs_2023-09-20.txt` using
`msigdb_pathways_to_tall_table.py`.

```
scriptdir=~/code/analysis-methods/script/DGIdb_and_MSigDB_pathways_aka_GSEA/
$scriptdir/msigdb_pathways_to_tall_table.py \
    --drugs \
    data/pathway_results_rollup_cohort \
    data/TH34_rollup_cohort_outliers_with_drugs_2023-09-20.txt \
    > data/TH34_tall_rollup_cohort_outliers_with_drugs_pathways_2023-09-28.tsv.txt
```
This generates the final result file:
`fff9a52894cc729fbce87e0eacfa516a  TH34_tall_rollup_cohort_outliers_with_drugs_pathways_2023-09-28.tsv.txt`


### Pancancer & pandisease outliers from uniform CARE results
These outliers were generated from the recompute of TH34 - ie, each sample underwent CARE vs its original
compendium, but using a modern (0.14.1 + ) version of CARE.

We start with the initial files generated by Holly and located in the root of CKCC2\_July\_2023
```
8105771d9e63acd09e13d2e19db21f8b  pan_cancer_outliers_from_PathsToOriginalTertiary.2022_01_18.tsv.tsv
e5184e801ad67e0e49ed95da26a8098c  pan_disease_outliers_from_PathsToOriginalTertiary.2022_01_18.tsv.tsv
```

First, convert them into table format, run DGIdb, and concatenate:
```
source/convert_outlier_lists_for_dgidb.py \
	../pan_cancer_outliers_from_PathsToOriginalTertiary.2022_01_18.tsv.tsv \
	pancancer > data/TH34_pancancer_outliers.txt
source/convert_outlier_lists_for_dgidb.py \
	../pan_disease_outliers_from_PathsToOriginalTertiary.2022_01_18.tsv.tsv \
	pandisease > data/TH34_pandisease_outliers.txt

$scriptdir/standalone_dgidb.py \
	data/TH34_pancancer_outliers.txt \
	data/TH34_pancancer_outliers_with_drugs_2023-10-03.txt
$scriptdir/standalone_dgidb.py \
	data/TH34_pandisease_outliers.txt \
	data/TH34_pandisease_outliers_with_drugs_2023-10-03.txt

cat data/TH34_pancancer_outliers_with_drugs_2023-10-03.txt \
	<(tail -n +2 data/TH34_pandisease_outliers_with_drugs_2023-10-03.txt) \
	> data/TH34_pc_pd_outliers_with_drugs_2023-10-03.txt
```
`8e724c46e47107826f1cf127ecd54a12  data/TH34_pc_pd_outliers_with_drugs_2023-10-03.txt`

In parallel, run MSigDB to get the pathways:

```
source/convert_outlier_lists_for_msigdb.py \
    ../pan_cancer_outliers_from_PathsToOriginalTertiary.2022_01_18.tsv.tsv \
    pancancer > tmp.pancancer
source/convert_outlier_lists_for_msigdb.py \
    ../pan_disease_outliers_from_PathsToOriginalTertiary.2022_01_18.tsv.tsv \
    pandisease > tmp.pandisease

cat tmp.pancancer tmp.pandisease > data/samples_outliers_wide_geneList_for_msigdb_2023-10-24.tsv
```
`700c03db3273945d9d12adc9ff6459c2  data/samples_outliers_wide_geneList_for_msigdb_2023-10-02.tsv`
`d29422eaf3467d4c091e8729893adf8e  data/samples_outliers_wide_geneList_for_msigdb_2023-10-24.tsv`

(Different from original version due to including compendium in the row headers.)

Calculate pathway results as before.

```
screen -S msigdb

docker run --rm -it -u `id -u`:`id -g` \
-v `pwd`:/workdir \
-v /private/home/ekephart/code/analysis-methods/:/analysis-methods:ro \
-v /private/groups/treehouse/archive:/archive:ro \
jupyter/datascience-notebook:python-3.11 /bin/bash

cd /workdir
mkdir data/pathway_results_pancancer_pandisease
cd data/pathway_results_pancancer_pandisease
ln -s ../samples_outliers_wide_geneList_for_msigdb_2023-10-24.tsv geneLists.txt
/analysis-methods/script/DGIdb_and_MSigDB_pathways_aka_GSEA/standalone_msigdb_pathways.R
```

This will produce 61 pathway files. (They have different names from the original run
but their contents are identical.)

Finally, build the tall table.
```
scriptdir=~/code/analysis-methods/script/DGIdb_and_MSigDB_pathways_aka_GSEA/
$scriptdir/msigdb_pathways_to_tall_table.py \
	--drugs \
	data/pathway_results_pancancer_pandisease \
	data/TH34_pc_pd_outliers_with_drugs_2023-10-03.txt \
	> data/TH34_tall_pancancer_pandisease_outliers_with_drugs_pathways_2023-10-03.tsv.txt

```

`1e870c72ea88556a25a6a5ba01ea1f3a  data/TH34_tall_pancancer_pandisease_outliers_with_drugs_pathways_2023-10-03.tsv.txt`
(Identical to original run.)

### Pan-pandisease outliers
- Run `source/retrieve_nonconsensus_pd_outliers.py`, providing a list of paths to CARE results.
This will generate a GeneLists file and a base "tall" file without drugs or pathways.

```
source/retrieve_nonconsensus_pd_outliers.py \
    ../input_data/PathsToOriginalTertiary.2022_01_18.tsv \
    data/geneLists_lowstringent-pd_2023-10-20.tsv \
    data/TH34_tall_lowstringent-pd_2023-10-20.tsv.txt
```

Output: `geneLists_lowstringent-pd_2023-10-20.tsv` , `TH34_tall_lowstringent-pd_2023-10-20.tsv.txt`

- Then, run `standalone_msigdb_pathways.R` from analysis\_methods, providing the GeneLists file.
This will generate one MSigDB result file for each list in the GeneLists file.

```
screen -S msigdb

docker run --rm -it -u `id -u`:`id -g` \
-v `pwd`:/workdir \
-v /private/home/ekephart/code/analysis-methods/:/analysis-methods:ro \
-v /private/groups/treehouse/archive:/archive:ro \
jupyter/datascience-notebook:python-3.11 /bin/bash

cd /workdir
mkdir pathway_results_lowstringent_pd
ln -s ../geneLists_lowstringent-pd_2023-10-20.tsv geneLists.txt
/analysis-methods/script/DGIdb_and_MSigDB_pathways_aka_GSEA/standalone_msigdb_pathways.R
```

Output: many files in `pathway_results_lowstringent_pd` eg `TH34_1150_S02-v8-lowstringency_pd_outliers_pathway_results.txt`.

- In parallel, run `standalone_dgidb.py` from analysis\_methods, providing the base "tall" file.
This will create a "tall" file with the drugs column attached.

```
~/code/analysis-methods/script/DGIdb_and_MSigDB_pathways_aka_GSEA/standalone_dgidb.py \
    TH34_tall_lowstringent-pd_2023-10-20.tsv.txt \
    TH34_tall_lowstringent-pd_drugs_2023-10-20.tsv.txt
```
Output: `TH34_tall_lowstringent-pd_drugs_2023-10-20.tsv.txt`

Then, use `msigdb_pathways_to_tall_table.py` from analysis\_methods, providing it the dir of MSigDB results and the "tall" file with drugs.
This will create a "tall" file with the pathways column attached.

```
scriptdir=~/code/analysis-methods/script/DGIdb_and_MSigDB_pathways_aka_GSEA/
$scriptdir/msigdb_pathways_to_tall_table.py \
    --drugs \
    data/pathway_results_lowstringent_pd \
    data/TH34_tall_lowstringent-pd_drugs_2023-10-20.tsv.txt \
    > data/TH34_tall_lowstringent-pd_drugs_pathways_2023-10-20.tsv.txt

Final output: `45373b46b8c2db05e873747f5185424d  TH34_tall_lowstringent-pd_drugs_2023-10-20.tsv.txt`
```

### Run pathway support on outliers only detected by TCGA rollup cohort
[Issue #10 - 2023 November 20](https://github.com/UCSC-Treehouse/CKCC2_July_2023/issues/10)
Workdir: `CKCC2_July_2023/gather_input_data`

Make the genelist and output dir for mSigDB:
```
tr "\n" "\t" < 'genes found only by TCGA in at least one sample.txt'  > genelist_found_by_TCGA_20231102.txt

mkdir standalone_msigdb/data/pathway_results_TCGA_at_least_one_sample
cp genelist_found_by_TCGA_20231102.txt standalone_msigdb/data/pathway_results_TCGA_at_least_one_sample/geneLists.txt
```

Run mSigDB:
```
docker run --rm -it -u `id -u`:`id -g` \
-v /`pwd`/standalone_msigdb/data/pathway_results_TCGA_at_least_one_sample:/workdir \
-v /private/home/ekephart/code/analysis-methods/:/analysis-methods:ro \
-v /private/groups/treehouse/archive:/archive:ro \
jupyter/datascience-notebook:python-3.11 /bin/bash

cd /workdir
/analysis-methods/script/DGIdb_and_MSigDB_pathways_aka_GSEA/standalone_msigdb_pathways.R
exit
```

This generates a single pathway results file, `gene_pathway_results.txt`.

Then, rename and manually make a "drugs file" so the "tall table" script can be used.

```
cd `pwd`/standalone_msigdb/data/pathway_results_TCGA_at_least_one_sample/
mv gene_pathway_results.txt THID-TCGA-AtLeastOneSample_pathway_results.txt
cd ..
# workdir: /private/home/ekephart/code/CKCC2_July_2023/gather_input_data/standalone_msigdb/data

# Set up the header

printf "gene\tSample_ID\tcompendium_version\trollup_cohort\n"> TCGA_only_at_least_one_sample-2023-11-20.tsv

# populate rows

while read line;
do echo -n $line;
printf "\tTHID\tTCGA\tAtLeastOneSample\n"; done \
< ../../genes\ found\ only\ by\ TCGA\ in\ at\ least\ one\ sample.txt  | tail -n +2 >> TCGA_only_at_least_one_sample-2023-11-20.tsv

```

Then make the Tall Table file `TCGA_only_at_least_one_sample-with_pathways-2023-11-20.tsv`
```
scriptdir=~/code/analysis-methods/script/DGIdb_and_MSigDB_pathways_aka_GSEA/
$scriptdir/msigdb_pathways_to_tall_table.py \
    --nodrugs \
   pathway_results_TCGA_at_least_one_sample \
   TCGA_only_at_least_one_sample-2023-11-20.tsv  \
    > TCGA_only_at_least_one_sample-with_pathways-2023-11-20.tsv

md5sum TCGA_only_at_least_one_sample-with_pathways-2023-11-20.tsv
# 2a9353c448acea33ac2be096dfbd3c00
```

Note that this file only has 17 lines, since the original input file `'genes found only by TCGA in at least one sample.txt'`
only has 16 unique genes despite being 22 lines long.

